<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - BetaHarvest</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      sizes="64x64"
      href="images/logobeta.svg"
      type="image/x-svg"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #eceff1;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      header {
        background-color: #ffffff;
        padding: 10px 20px;
        text-align: left;
        width: 100%;
        position: fixed;
        top: 0;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      header .logo {
        display: flex;
        align-items: center;
      }
      header .logo img {
        height: 50px;
        padding: 15px;
      }
      header .logo h3 {
        margin-left: 10px;
        font-size: 1.5rem;
        color: #333;
      }
      header .home-icon img {
        height: 40px;
        padding-right: 30px;
        cursor: pointer;
      }
      .settings-icon {
        border: none;
        background: none;
        padding: 0;
        padding-right: 40px;
        margin: 0;
        cursor: pointer;
      }

      .settings-icon img {
        height: 24px;
        cursor: pointer;
        transition: transform 0.5s;
      }

      .rotate {
        animation: rotate360 0.5s;
      }

      @keyframes rotate360 {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .settings-menu {
        display: none;
        position: absolute;
        right: 50px;
        padding: 15px;
        top: 60px;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
        z-index: 1001;
      }

      .settings-menu a {
        display: block;
        padding: 10px 20px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
      }

      .settings-menu a:hover {
        background-color: #f0f4f8;
      }

      .main-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        margin-top: 90px;
        flex-grow: 1;
      }
      .dashboard {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        width: 100%;
        max-width: 1200px;
      }
      .dashboard-item {
        background: #ffffff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .weather-card,
      .crop-card,
      .recommendation-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .weather-card h2,
      .crop-card h2,
      .recommendation-card h2 {
        margin: 0;
        font-size: 1.2rem;
      }
      .recommendation-card .ai-recommendation {
        text-align: left;
        width: 100%;
      }
      @media (min-width: 768px) {
        .dashboard {
          grid-template-columns: repeat(2, 1fr);
        }
        .recommendation-card {
          grid-column: span 2;
        }
      }
      @media (min-width: 1024px) {
        .dashboard {
          grid-template-columns: repeat(3, 1fr);
        }
        .recommendation-card {
          grid-column: span 3;
        }
      }
      .logs-card {
        background: #ffffff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">
        <img src="images/logobeta.svg" alt="BetaHarvest logo" />
        <h3>BetaHarvest</h3>
      </div>
      <div class="relative">
        <button class="settings-icon" onclick="toggleSettingsMenu()">
          <img src="images/menu.png" alt="menu_icon" id="menuIcon" />
        </button>
        <div class="settings-menu" id="settingsMenu">
          <a href="dashboard.html">Dashboard</a>
          <a href="crop_detail.html">Crops Details</a>
          <a href="farmer-log.html">Farm Log</a>
          <a href="bot.html">ChatBot</a>
          <a href="index.html" onclick="sessionStorage.clear();">Logout</a>
        </div>
      </div>
    </header>
    <div class="main-content">
      <div class="dashboard">
        <div class="dashboard-item weather-card">
          <h2>Today Weather Condition</h2>
          <div id="weather-data"></div>
        </div>
        <div class="dashboard-item crop-card">
          <h2>Crop Stage</h2>
          <p id="crop-stage-prediction">Loading...</p>
        </div>
        <div id="recentFarmLog" class="dashboard-item logs-card hidden">
          <h2>Recent Farmer's Log</h2>
          <div id="recentLogEntry"></div>
        </div>
        <div class="dashboard-item recommendation-card">
          <h2>AI Recommendation</h2>
          <div class="ai-recommendation" id="ai-recommendation"></div>
        </div>
      </div>
    </div>
    <script type="module">
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        orderBy,
        limit,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBYhzRyNuh7NWh8YXIdHyuwZHE_fIZGX9Y",
        authDomain: "mybetaharvest.firebaseapp.com",
        projectId: "mybetaharvest",
        storageBucket: "mybetaharvest.appspot.com",
        messagingSenderId: "370925949496",
        appId: "1:370925949496:web:6fe3dea100315059f40ccd",
        measurementId: "G-BE44KWEGR2",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const userID = sessionStorage.getItem("userID");

      if (!userID) {
        window.location.href = "login.html";
      }

      const userAddress = sessionStorage.getItem("userAddress");
      const userEmail = sessionStorage.getItem("userEmail");
      const userState = sessionStorage.getItem("userState");
      const userCrop = sessionStorage.getItem("userCrop");
      const userCountry = sessionStorage.getItem("userCountry");
      const fullname = sessionStorage.getItem("userFullname");
      const todayDate = new Date().toISOString().split("T")[0];

      const API_KEY = "AIzaSyBNUqanEBKJvOrOvmkmsDnHVGTv7kVXZ44";
      const genAI = new GoogleGenerativeAI(API_KEY);
      const model = genAI.getGenerativeModel({
        model: "gemini-1.5-pro-latest",
      });

      async function fetchAIRecommendation() {
        const userLog = await fetchRecentLog();
        const farmlog = await fetchAllLogs();
        const weatherCondition = await fetchWeatherData();

        const prompt = `Given the following information about the farmer:
          Location: ${userAddress}, ${userCountry}, ${userState}
          Username: ${fullname}
          Date: ${todayDate}
          Crop Planted: ${userCrop}
          Farm log Activities (Past and Present): ${farmlog}
          Weather Condition: ${weatherCondition}
  
          Consider the following factors when providing recommendations:
          - Current season and weather conditions specific to ${userCountry} and ${userState} based on today's date: ${todayDate}
          - Soil type and condition in the farmer's location
          - Optimal planting and harvesting times for ${userCrop}
          - Common pests and diseases in the region, along with prevention and treatment methods
          - Best irrigation practices for ${userCrop}
  
          If there is no farm log activity, suggest the perfect time for the farmer to start planting their crop.
          Provide recommendations based on these factors to achieve optimal yield and ensure disease-free crops. Keep it concise and within 40 words.`;

        try {
          const result = await model.generateContent(prompt);
          const response = await result.response;
          const text = await response.text();
          displayAIRecommendation(text);
        } catch (error) {
          console.error("Error generating AI recommendation:", error);
          displayAIRecommendation(
            "Sorry, there was an error fetching your AI recommendation. Please try again later."
          );
        }
      }

      async function fetchAllLogs() {
        const farmerslogCollectionRef = collection(
          db,
          "farmer_log",
          userID,
          "log"
        );
        const q = query(farmerslogCollectionRef, orderBy("date", "desc"));

        try {
          const querySnapshot = await getDocs(q);
          const logs = [];
          querySnapshot.forEach((doc) => {
            logs.push(doc.data());
          });
          return JSON.stringify(logs);
        } catch (error) {
          console.error("Error fetching all logs: ", error);
          return "Error fetching logs.";
        }
      }

      async function fetchRecentLog() {
        const farmerslogCollectionRef = collection(
          db,
          "farmer_log",
          userID,
          "log"
        );
        const q = query(
          farmerslogCollectionRef,
          orderBy("date", "desc"),
          limit(1)
        );

        try {
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            const logData = querySnapshot.docs[0].data();
            updateRecentLogDisplay(logData);
            return JSON.stringify(logData);
          } else {
            updateRecentLogDisplay(null);
            return "No recent log";
          }
        } catch (error) {
          console.error("Error fetching recent log: ", error);
          updateRecentLogDisplay(null);
          return "Error fetching recent log.";
        }
      }

      function updateRecentLogDisplay(log) {
        const recentLogEntry = document.getElementById("recentLogEntry");
        const recentFarmLog = document.getElementById("recentFarmLog");

        if (log) {
          recentLogEntry.innerHTML = `
          <p><strong>Date:</strong> ${log.date} | <strong>Time:</strong> ${
            log.time
          }</p>
          <p><strong>Activity:</strong> ${log.activity}</p>
          <p><strong>Note:</strong> ${log.note || "N/A"}</p>
        `;
          recentFarmLog.classList.remove("hidden");
        } else {
          recentLogEntry.innerHTML = "No recent log";
        }
      }

      async function fetchWeatherData() {
        const apiKey = "6643a51c878047b6aed175732241007";
        const position = await getCurrentPosition();
        const { latitude, longitude } = position.coords;
        try {
          const response = await fetch(
            `https://api.weatherapi.com/v1/current.json?key=${apiKey}&q=${latitude},${longitude}`
          );
          const data = await response.json();
          document.getElementById("weather-data").innerHTML = `
            <p>${data.location.name}, ${data.location.region}</p>
            <p>${data.current.temp_c}Â°C - ${data.current.condition.text}</p>
            <p>Humidity: ${data.current.humidity}%</p>
            <p>Wind Speed: ${data.current.wind_kph} km/h</p>
          `;
          return JSON.stringify(data.current);
        } catch (error) {
          console.error("Error fetching weather data:", error);
          return "Error fetching weather data.";
        }
      }

      function getCurrentPosition() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error("Geolocation is not supported by this browser."));
          } else {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          }
        });
      }

      async function fetchAndDisplayCropStage() {
        const cropStageElement = document.querySelector(".crop-card");

        try {
          const crop_stageCollectionRef = collection(
            db,
            "crop_stage",
            userID,
            "stage"
          );
          const q = query(
            crop_stageCollectionRef,
            orderBy("timestamp", "desc"),
            limit(1)
          );
          const querySnapshot = await getDocs(q);

          if (!querySnapshot.empty) {
            const latestStage = querySnapshot.docs[0].data().prediction;
            cropStageElement.innerHTML = `
              <h2>Crop Stage</h2>
              <p>${latestStage}</p>
            `;
          } else {
            cropStageElement.innerHTML = `
              <h2>Crop Stage</h2>
              <p>No crop stage data available yet.</p>
            `;
          }
        } catch (error) {
          console.error("Error fetching crop stage: ", error);
          cropStageElement.innerHTML = `
            <h2>Crop Stage</h2>
            <p>Error fetching crop stage.</p>
          `;
        }
      }

      function displayAIRecommendation(recommendation) {
        const aiRecommendationElement =
          document.getElementById("ai-recommendation");
        aiRecommendationElement.textContent = recommendation;
      }

      window.toggleSettingsMenu = function () {
        const settingsMenu = document.getElementById("settingsMenu");
        const menuIcon = document.getElementById("menuIcon");
        const isOpen = settingsMenu.style.display === "block";
        settingsMenu.style.display = isOpen ? "none" : "block";
        menuIcon.classList.add("rotate");
        setTimeout(() => menuIcon.classList.remove("rotate"), 500);
      };

      fetchAIRecommendation();
      fetchWeatherData();
      fetchAndDisplayCropStage();
    </script>
  </body>
</html>
